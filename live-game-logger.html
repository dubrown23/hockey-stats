<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Live Game Logger</title>
    <style>
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; touch-action: manipulation; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #e8e8e8;
            color: #111;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            padding: clamp(4px, 1vmin, 10px);
            gap: clamp(4px, 1vmin, 8px);
        }

        /* HEADER */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            border-radius: clamp(6px, 1.5vmin, 10px);
            padding: clamp(3px, 0.8vmin, 6px) clamp(6px, 1.5vmin, 12px);
            flex-shrink: 0;
        }

        .header-left { display: flex; align-items: center; gap: clamp(4px, 1vmin, 8px); }
        .lock-indicator { font-size: clamp(14px, 3vmin, 22px); }

        .game-badge {
            background: #fbbf24;
            color: #000;
            padding: clamp(2px, 0.5vmin, 4px) clamp(6px, 1.5vmin, 10px);
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }
        .game-badge-label { font-size: clamp(6px, 1.2vmin, 9px); text-transform: uppercase; }
        .game-badge-num { font-size: clamp(12px, 3vmin, 20px); line-height: 1; }

        .goalie-display {
            background: #000;
            border: 2px solid #fbbf24;
            border-radius: 6px;
            padding: clamp(2px, 0.5vmin, 4px) clamp(6px, 1.5vmin, 10px);
            text-align: center;
        }
        .goalie-num { font-size: clamp(12px, 3vmin, 20px); font-weight: bold; color: #fbbf24; line-height: 1; }
        .goalie-name { font-size: clamp(6px, 1.2vmin, 10px); color: #aaa; }

        .header-center { display: flex; gap: clamp(2px, 0.5vmin, 4px); }

        .period-summary {
            text-align: center;
            padding: clamp(2px, 0.5vmin, 4px) clamp(4px, 1vmin, 6px);
            border-radius: 6px;
            background: #555;
            min-width: clamp(60px, 15vmin, 100px);
        }
        .period-summary.active { background: #fbbf24; color: #000; }
        .period-summary.saved { background: #22c55e; color: #fff; }
        .period-label { font-size: clamp(6px, 1.2vmin, 10px); text-transform: uppercase; color: #ccc; }
        .period-summary.active .period-label { color: #333; }
        .period-summary.saved .period-label { color: #fff; }
        .period-data { font-size: clamp(7px, 1.5vmin, 11px); font-weight: bold; color: #fff; white-space: nowrap; }
        .period-summary.active .period-data { color: #000; }
        .period-data.empty { opacity: 0.5; }

        .header-right { display: flex; gap: clamp(3px, 0.8vmin, 6px); }

        .header-btn {
            padding: clamp(4px, 1vmin, 8px) clamp(8px, 2vmin, 14px);
            background: #6366f1;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            font-size: clamp(8px, 1.8vmin, 12px);
            cursor: pointer;
        }
        .header-btn:disabled { opacity: 0.5; }
        .header-btn.locked { background: #dc2626; }

        /* FACEOFFS - 55% of space */
        .fo-section {
            flex: 55;
            background: #d0d0d0;
            border-radius: clamp(8px, 2vmin, 14px);
            padding: clamp(4px, 1vmin, 8px);
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .fo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: clamp(4px, 1vmin, 8px);
            flex: 1;
            min-height: 0;
        }

        .fo-card {
            border-radius: clamp(8px, 2vmin, 14px);
            padding: clamp(4px, 1vmin, 10px);
            display: flex;
            flex-direction: column;
            border: clamp(2px, 0.5vmin, 4px) solid;
            min-height: 0;
            overflow: hidden;
            position: relative;
        }
        
        /* Muted pastel backgrounds - will be assigned dynamically via JS */
        .fo-card.color-blue { background: #93c5fd; border-color: #3b82f6; }
        .fo-card.color-purple { background: #d8b4fe; border-color: #a855f7; }
        .fo-card.color-gold { background: #fde68a; border-color: #f59e0b; }
        .fo-card.color-orange { background: #fed7aa; border-color: #f97316; }

        .fo-card-label {
            font-size: clamp(28px, 6vmin, 48px);
            font-weight: bold;
            color: #333;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            line-height: 1;
            text-align: center;
            flex-shrink: 0;
        }

        .fo-tap-row { 
            display: flex; 
            justify-content: center;
            gap: clamp(8px, 2vmin, 20px); 
            flex: 1;
            align-items: center;
            margin-top: 4px;
            min-height: 0;
            padding: 4px;
        }

        /* Circular W/L buttons - responsive sizing */
        .fo-tap-btn {
            /* Size based on available height, max out at reasonable size */
            width: clamp(70px, 18vmin, 180px);
            height: clamp(70px, 18vmin, 180px);
            border-radius: 50%;
            border: clamp(3px, 0.8vmin, 6px) solid white;
            font-size: clamp(24px, 6vmin, 56px);
            font-weight: bold;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.35);
            flex-shrink: 0;
        }
        .fo-tap-btn:active { transform: scale(0.95); }
        .fo-tap-btn.win { background: #16a34a; }
        .fo-tap-btn.loss { background: #dc2626; }

        .fo-card-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: clamp(4px, 1vmin, 8px);
            flex-shrink: 0;
        }

        .fo-card-stats { 
            background: rgba(0,0,0,0.2);
            padding: clamp(2px, 0.5vmin, 6px) clamp(8px, 2vmin, 16px);
            border-radius: 6px;
            color: #333;
            font-weight: bold;
            font-size: clamp(14px, 3vmin, 22px);
        }

        .fo-dec-btn {
            width: clamp(32px, 8vmin, 56px);
            height: clamp(26px, 5vmin, 40px);
            border: none;
            border-radius: 6px;
            background: rgba(0,0,0,0.25);
            color: #333;
            font-size: clamp(16px, 3.5vmin, 26px);
            font-weight: bold;
            cursor: pointer;
        }
        .fo-dec-btn:active { background: rgba(0,0,0,0.4); }

        /* TEAM TOTAL */
        .fo-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            border-radius: clamp(4px, 1vmin, 8px);
            padding: clamp(3px, 0.8vmin, 6px) clamp(6px, 1.5vmin, 12px);
            margin-top: clamp(3px, 0.8vmin, 6px);
            flex-shrink: 0;
        }
        
        .fo-total-team { display: flex; align-items: center; gap: clamp(4px, 1vmin, 10px); }
        .fo-total-label { font-size: clamp(10px, 2vmin, 14px); color: #aaa; text-transform: uppercase; font-weight: bold; }
        .fo-total-pct { font-size: clamp(18px, 4vmin, 28px); font-weight: bold; color: #fff; }
        .fo-total-sub { font-size: clamp(10px, 2vmin, 14px); color: #ccc; font-weight: bold; }
        
        .fo-individual-stats { display: flex; gap: clamp(3px, 0.6vmin, 6px); }
        .fo-ind-stat { text-align: center; padding: clamp(2px, 0.5vmin, 4px) clamp(4px, 1vmin, 8px); border-radius: 5px; }
        /* Muted colors for individual stats - dynamic via JS */
        .fo-ind-stat.color-blue { background: #93c5fd; }
        .fo-ind-stat.color-purple { background: #d8b4fe; }
        .fo-ind-stat.color-gold { background: #fde68a; }
        .fo-ind-stat.color-orange { background: #fed7aa; }
        .fo-ind-label { font-size: clamp(6px, 1.2vmin, 10px); font-weight: bold; color: #333; }
        .fo-ind-value { font-size: clamp(8px, 1.6vmin, 12px); font-weight: bold; color: #333; white-space: nowrap; }

        /* GOALIE - 45% of space */
        .goalie-section {
            flex: 45;
            background: #333;
            border-radius: clamp(8px, 2vmin, 14px);
            padding: clamp(4px, 1vmin, 10px);
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .goalie-tap-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: clamp(6px, 1.5vmin, 14px); 
            flex: 1;
            min-height: 0;
        }
        
        .goalie-tap-wrapper { 
            display: flex; 
            flex-direction: column; 
            min-height: 0;
        }

        .goalie-tap-btn {
            flex: 1;
            min-height: clamp(60px, 12vmin, 120px);
            border-radius: clamp(8px, 2vmin, 14px);
            border: clamp(3px, 0.6vmin, 5px) solid;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .goalie-tap-btn:active { transform: scale(0.97); }
        .goalie-tap-btn.shot { background: #15803d; border-color: #22c55e; }
        .goalie-tap-btn.goal { background: #b91c1c; border-color: #ef4444; }
        .goalie-tap-label { font-size: clamp(12px, 2.5vmin, 20px); font-weight: bold; color: white; text-transform: uppercase; }
        .goalie-tap-count { font-size: clamp(36px, 8vmin, 64px); font-weight: bold; color: white; line-height: 1; }

        .goalie-tap-dec {
            width: 60%;
            height: clamp(22px, 4vmin, 34px);
            margin: clamp(2px, 0.5vmin, 6px) auto 0;
            background: #555;
            border: none;
            border-radius: 5px;
            color: #fff;
            font-size: clamp(10px, 2vmin, 14px);
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
        }

        .goalie-stats {
            display: flex;
            justify-content: center;
            gap: clamp(16px, 4vmin, 40px);
            background: #222;
            border-radius: clamp(6px, 1.5vmin, 10px);
            padding: clamp(4px, 1vmin, 10px);
            margin-top: clamp(4px, 1vmin, 8px);
            flex-shrink: 0;
        }
        .goalie-stat-item { text-align: center; }
        .goalie-stat-value { font-size: clamp(20px, 4.5vmin, 34px); font-weight: bold; color: #fff; }
        .goalie-stat-value.shots { color: #22c55e; }
        .goalie-stat-value.ga { color: #ef4444; }
        .goalie-stat-value.svpct { color: #fbbf24; }
        .goalie-stat-label { font-size: clamp(8px, 1.6vmin, 12px); color: #aaa; text-transform: uppercase; }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: clamp(10px, 3vmin, 25px);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #15803d;
            color: white;
            padding: clamp(10px, 2vmin, 18px) clamp(18px, 4vmin, 34px);
            border-radius: clamp(8px, 1.5vmin, 12px);
            font-weight: bold;
            font-size: clamp(14px, 3vmin, 22px);
            transition: transform 0.3s ease;
            z-index: 200;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.error { background: #b91c1c; }

        /* MODALS */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: clamp(12px, 3vmin, 24px);
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: #2a2a2a;
            border-radius: clamp(12px, 2.5vmin, 20px);
            padding: clamp(14px, 3vmin, 24px);
            width: 100%;
            max-width: min(400px, 90vw);
        }

        .modal-title { font-size: clamp(16px, 3.5vmin, 24px); font-weight: bold; color: #fbbf24; text-align: center; margin-bottom: clamp(14px, 3vmin, 24px); }
        .modal-section { margin-bottom: clamp(14px, 3vmin, 24px); }
        .modal-section label { display: block; font-size: clamp(10px, 2vmin, 14px); color: #aaa; text-transform: uppercase; margin-bottom: clamp(6px, 1.2vmin, 10px); }

        .modal-input {
            width: 100%;
            padding: clamp(10px, 2vmin, 16px);
            background: #444;
            border: 2px solid #555;
            border-radius: 8px;
            color: #fff;
            font-size: clamp(14px, 2.5vmin, 18px);
        }
        .modal-input:focus { outline: none; border-color: #6366f1; }

        .goalie-select-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: clamp(6px, 1.5vmin, 12px); }

        .goalie-select-btn {
            padding: clamp(10px, 2vmin, 18px) clamp(6px, 1.5vmin, 12px);
            background: #444;
            border: 2px solid #555;
            border-radius: clamp(8px, 1.5vmin, 12px);
            cursor: pointer;
            text-align: center;
        }
        .goalie-select-btn.selected { background: #6366f1; border-color: #6366f1; }
        .goalie-select-btn .num { font-size: clamp(18px, 4vmin, 28px); font-weight: bold; color: #fbbf24; }
        .goalie-select-btn.selected .num { color: white; }
        .goalie-select-btn .name { font-size: clamp(9px, 1.8vmin, 13px); color: #aaa; }
        .goalie-select-btn.selected .name { color: #ddd; }

        .modal-buttons { display: flex; gap: clamp(6px, 1.5vmin, 12px); flex-wrap: wrap; }

        .modal-btn {
            flex: 1;
            min-width: 45%;
            padding: clamp(12px, 2.5vmin, 20px);
            border: none;
            border-radius: 8px;
            font-size: clamp(12px, 2.5vmin, 18px);
            font-weight: bold;
            cursor: pointer;
        }
        .modal-btn.cancel { background: #555; color: #fff; }
        .modal-btn.confirm { background: #15803d; color: white; }
        .modal-btn.period { background: #6366f1; color: white; }
        .modal-btn.game { background: #15803d; color: white; }
        .modal-btn.lock-only { background: #dc2626; color: white; }

        .url-note { font-size: clamp(9px, 1.8vmin, 13px); color: #888; margin-top: clamp(6px, 1.2vmin, 10px); text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <div class="header-left">
                <span class="lock-indicator" id="lockIndicator">üîì</span>
                <div class="game-badge">
                    <div class="game-badge-label">Game</div>
                    <div class="game-badge-num" id="gameNum">1</div>
                </div>
                <div class="goalie-display">
                    <div class="goalie-num" id="goalieNum">#31</div>
                    <div class="goalie-name" id="goalieName">Tomasula</div>
                </div>
            </div>
            <div class="header-center">
                <div class="period-summary active" id="periodP1">
                    <div class="period-label">P1</div>
                    <div class="period-data empty" id="periodP1Data">--</div>
                </div>
                <div class="period-summary" id="periodP2">
                    <div class="period-label">P2</div>
                    <div class="period-data empty" id="periodP2Data">--</div>
                </div>
                <div class="period-summary" id="periodP3">
                    <div class="period-label">P3</div>
                    <div class="period-data empty" id="periodP3Data">--</div>
                </div>
                <div class="period-summary" id="periodGame">
                    <div class="period-label">Game</div>
                    <div class="period-data empty" id="periodGameData">--</div>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" id="setupBtn" onclick="openSetup()">Setup</button>
                <button class="header-btn" id="lockBtn" onclick="handleLockBtn()">Lock</button>
            </div>
        </div>

        <div class="fo-section">
            <div class="fo-grid">
                <div class="fo-card color-blue" id="foCard_c1">
                    <div class="fo-card-label" id="foLabel_c1">c1</div>
                    <div class="fo-tap-row">
                        <button class="fo-tap-btn win" id="foBtnW_c1" onclick="foTap('c1', 'w')">W</button>
                        <button class="fo-tap-btn loss" id="foBtnL_c1" onclick="foTap('c1', 'l')">L</button>
                    </div>
                    <div class="fo-card-bottom">
                        <button class="fo-dec-btn" onclick="foDec('c1', 'w')">‚àí</button>
                        <span class="fo-card-stats" id="foStats_c1">0-0</span>
                        <button class="fo-dec-btn" onclick="foDec('c1', 'l')">‚àí</button>
                    </div>
                </div>
                <div class="fo-card color-purple" id="foCard_c2">
                    <div class="fo-card-label" id="foLabel_c2">c2</div>
                    <div class="fo-tap-row">
                        <button class="fo-tap-btn win" id="foBtnW_c2" onclick="foTap('c2', 'w')">W</button>
                        <button class="fo-tap-btn loss" id="foBtnL_c2" onclick="foTap('c2', 'l')">L</button>
                    </div>
                    <div class="fo-card-bottom">
                        <button class="fo-dec-btn" onclick="foDec('c2', 'w')">‚àí</button>
                        <span class="fo-card-stats" id="foStats_c2">0-0</span>
                        <button class="fo-dec-btn" onclick="foDec('c2', 'l')">‚àí</button>
                    </div>
                </div>
                <div class="fo-card color-gold" id="foCard_c3">
                    <div class="fo-card-label" id="foLabel_c3">c3</div>
                    <div class="fo-tap-row">
                        <button class="fo-tap-btn win" id="foBtnW_c3" onclick="foTap('c3', 'w')">W</button>
                        <button class="fo-tap-btn loss" id="foBtnL_c3" onclick="foTap('c3', 'l')">L</button>
                    </div>
                    <div class="fo-card-bottom">
                        <button class="fo-dec-btn" onclick="foDec('c3', 'w')">‚àí</button>
                        <span class="fo-card-stats" id="foStats_c3">0-0</span>
                        <button class="fo-dec-btn" onclick="foDec('c3', 'l')">‚àí</button>
                    </div>
                </div>
                <div class="fo-card color-orange" id="foCard_other">
                    <div class="fo-card-label" id="foLabel_other">OTHER</div>
                    <div class="fo-tap-row">
                        <button class="fo-tap-btn win" id="foBtnW_other" onclick="foTap('other', 'w')">W</button>
                        <button class="fo-tap-btn loss" id="foBtnL_other" onclick="foTap('other', 'l')">L</button>
                    </div>
                    <div class="fo-card-bottom">
                        <button class="fo-dec-btn" onclick="foDec('other', 'w')">‚àí</button>
                        <span class="fo-card-stats" id="foStats_other">0-0</span>
                        <button class="fo-dec-btn" onclick="foDec('other', 'l')">‚àí</button>
                    </div>
                </div>
            </div>
            <div class="fo-total">
                <div class="fo-total-team">
                    <span class="fo-total-label">Team</span>
                    <span class="fo-total-pct" id="foTeamPct">-</span>
                    <span class="fo-total-sub" id="foTeamSub">0W - 0L</span>
                </div>
                <div class="fo-individual-stats">
                    <div class="fo-ind-stat color-blue" id="foIndStat_c1">
                        <div class="fo-ind-label" id="foIndLabel_c1">c1</div>
                        <div class="fo-ind-value" id="foIndValue_c1">-</div>
                    </div>
                    <div class="fo-ind-stat color-purple" id="foIndStat_c2">
                        <div class="fo-ind-label" id="foIndLabel_c2">c2</div>
                        <div class="fo-ind-value" id="foIndValue_c2">-</div>
                    </div>
                    <div class="fo-ind-stat color-gold" id="foIndStat_c3">
                        <div class="fo-ind-label" id="foIndLabel_c3">c3</div>
                        <div class="fo-ind-value" id="foIndValue_c3">-</div>
                    </div>
                    <div class="fo-ind-stat color-orange" id="foIndStat_other">
                        <div class="fo-ind-label">OTH</div>
                        <div class="fo-ind-value" id="foIndValue_other">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="goalie-section">
            <div class="goalie-tap-grid">
                <div class="goalie-tap-wrapper">
                    <div class="goalie-tap-btn shot" onclick="tapShot()">
                        <div class="goalie-tap-label">Shot</div>
                        <div class="goalie-tap-count" id="shotCount">0</div>
                    </div>
                    <button class="goalie-tap-dec" onclick="undoShot()">‚àí Undo</button>
                </div>
                <div class="goalie-tap-wrapper">
                    <div class="goalie-tap-btn goal" onclick="tapGoal()">
                        <div class="goalie-tap-label">Goal</div>
                        <div class="goalie-tap-count" id="goalCount">0</div>
                    </div>
                    <button class="goalie-tap-dec" onclick="undoGoal()">‚àí Undo</button>
                </div>
            </div>
            <div class="goalie-stats">
                <div class="goalie-stat-item">
                    <div class="goalie-stat-value shots" id="statShots">-</div>
                    <div class="goalie-stat-label">Shots</div>
                </div>
                <div class="goalie-stat-item">
                    <div class="goalie-stat-value ga" id="statGA">-</div>
                    <div class="goalie-stat-label">GA</div>
                </div>
                <div class="goalie-stat-item">
                    <div class="goalie-stat-value svpct" id="statSVPct">-</div>
                    <div class="goalie-stat-label">SV%</div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Setup Modal -->
    <div class="modal-overlay" id="setupModal">
        <div class="modal">
            <div class="modal-title">‚öôÔ∏è Game Setup</div>
            <div class="modal-section">
                <label>Apps Script URL</label>
                <input type="text" class="modal-input" id="scriptUrl" placeholder="Paste Google Apps Script URL">
                <div class="url-note">Same URL used in main stat entry app</div>
            </div>
            <div class="modal-section">
                <label>Game Number</label>
                <input type="number" class="modal-input" id="inputGameNum" min="1" max="50" value="1">
            </div>
            <div class="modal-section">
                <label>Goalie</label>
                <div class="goalie-select-grid">
                    <div class="goalie-select-btn selected" id="setupGoalie31" onclick="selectSetupGoalie(31, 'Tomasula')">
                        <div class="num">#31</div>
                        <div class="name">Tomasula</div>
                    </div>
                    <div class="goalie-select-btn" id="setupGoalie41" onclick="selectSetupGoalie(41, 'Goodwin')">
                        <div class="num">#41</div>
                        <div class="name">Goodwin</div>
                    </div>
                    <div class="goalie-select-btn" id="setupGoalie67" onclick="selectSetupGoalie(67, 'Nease')">
                        <div class="num">#67</div>
                        <div class="name">Nease</div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeSetup()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmSetup()">Start Game</button>
            </div>
        </div>
    </div>

    <!-- Lock/Save Modal - shows when you tap Lock -->
    <div class="modal-overlay" id="lockModal">
        <div class="modal">
            <div class="modal-title">üîí Save & Lock</div>
            <div class="modal-buttons">
                <button class="modal-btn period" onclick="savePeriodAndLock()">Save Period</button>
                <button class="modal-btn game" onclick="saveGameAndLock()">Save Game</button>
                <button class="modal-btn lock-only" onclick="justLock()">Just Lock</button>
                <button class="modal-btn cancel" onclick="closeLockModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let SCRIPT_URL = localStorage.getItem('hockeyScriptUrl') || '';
        let isLocked = false;
        let currentPeriod = 1;

        // Track which center currently has purple (best FO%)
        let purpleCenter = null; // null until someone wins a faceoff

        const gameState = {
            gameNum: 1,
            goalie: { num: 31, name: 'Tomasula', value: '#31 Tomasula' },
            fo: { c1: { w: 0, l: 0 }, c2: { w: 0, l: 0 }, c3: { w: 0, l: 0 }, other: { w: 0, l: 0 } },
            labels: { c1: 'c1', c2: 'c2', c3: 'c3', other: 'OTHER' },
            periodShots: 0,
            periodGoals: 0,
            totalShots: 0,
            totalGoals: 0
        };

        const periodData = { 1: null, 2: null, 3: null };
        const setupState = { goalie: { num: 31, name: 'Tomasula' } };

        // Color assignment for centers (OTHER is always orange)
        function updateCardColors() {
            const centers = ['c1', 'c2', 'c3'];
            
            // Calculate cumulative FO% for each center
            const stats = {};
            centers.forEach(c => {
                let w = 0, l = 0;
                [1, 2, 3].forEach(p => { 
                    if (periodData[p] && periodData[p].fo[c]) { 
                        w += periodData[p].fo[c].w; 
                        l += periodData[p].fo[c].l; 
                    } 
                });
                w += gameState.fo[c].w;
                l += gameState.fo[c].l;
                const total = w + l;
                stats[c] = { w, l, total, pct: total > 0 ? (w / total) * 100 : 0 };
            });
            
            // Determine who should have purple
            let bestCenter = null;
            let bestPct = -1;
            
            // Only assign purple if someone has taken at least one faceoff
            const anyFaceoffs = centers.some(c => stats[c].total > 0);
            
            if (anyFaceoffs) {
                // If no one has purple yet, find the best
                if (purpleCenter === null) {
                    centers.forEach(c => {
                        if (stats[c].total > 0 && stats[c].pct > bestPct) {
                            bestPct = stats[c].pct;
                            bestCenter = c;
                        }
                    });
                    purpleCenter = bestCenter;
                } else {
                    // Check if someone else beat the current purple holder
                    const currentPurplePct = stats[purpleCenter].pct;
                    centers.forEach(c => {
                        if (c !== purpleCenter && stats[c].total > 0 && stats[c].pct > currentPurplePct) {
                            // Someone else is better now
                            if (stats[c].pct > bestPct) {
                                bestPct = stats[c].pct;
                                bestCenter = c;
                            }
                        }
                    });
                    if (bestCenter) {
                        purpleCenter = bestCenter;
                    }
                }
            }
            
            // Assign colors: purple to leader, blue and gold to others
            const colorAssignments = {};
            const availableColors = ['blue', 'gold'];
            
            centers.forEach(c => {
                if (c === purpleCenter) {
                    colorAssignments[c] = 'purple';
                } else {
                    colorAssignments[c] = availableColors.shift() || 'blue';
                }
            });
            colorAssignments['other'] = 'orange';
            
            // Apply colors to cards and individual stats
            ['c1', 'c2', 'c3', 'other'].forEach(c => {
                const card = document.getElementById('foCard_' + c);
                const indStat = document.getElementById('foIndStat_' + c);
                
                // Remove all color classes
                card.classList.remove('color-blue', 'color-purple', 'color-gold', 'color-orange');
                indStat.classList.remove('color-blue', 'color-purple', 'color-gold', 'color-orange');
                
                // Add the assigned color
                card.classList.add('color-' + colorAssignments[c]);
                indStat.classList.add('color-' + colorAssignments[c]);
            });
        }

        // Setup Modal
        function openSetup() {
            if (isLocked) return;
            document.getElementById('setupModal').classList.add('active');
            document.getElementById('scriptUrl').value = SCRIPT_URL;
            document.getElementById('inputGameNum').value = gameState.gameNum;
        }

        function closeSetup() { document.getElementById('setupModal').classList.remove('active'); }

        function selectSetupGoalie(num, name) {
            setupState.goalie = { num, name };
            document.querySelectorAll('.goalie-select-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('setupGoalie' + num).classList.add('selected');
        }

        async function confirmSetup() {
            const url = document.getElementById('scriptUrl').value.trim();
            const gameNum = parseInt(document.getElementById('inputGameNum').value) || 1;
            if (!url) { showToast('Enter Apps Script URL', true); return; }
            SCRIPT_URL = url;
            localStorage.setItem('hockeyScriptUrl', url);
            gameState.gameNum = gameNum;
            gameState.goalie = { num: setupState.goalie.num, name: setupState.goalie.name, value: '#' + setupState.goalie.num + ' ' + setupState.goalie.name };
            document.getElementById('gameNum').textContent = gameNum;
            document.getElementById('goalieNum').textContent = '#' + setupState.goalie.num;
            document.getElementById('goalieName').textContent = setupState.goalie.name;
            await loadCenterLabels();
            closeSetup();
            showToast('Game ' + gameNum + ' ready!');
        }

        async function loadCenterLabels() {
            if (!SCRIPT_URL) return;
            try {
                const response = await fetch(SCRIPT_URL + '?action=getFOSTState&gameNum=' + gameState.gameNum + '&t=' + Date.now());
                const data = await response.json();
                if (data.labels) {
                    gameState.labels = data.labels;
                    ['c1', 'c2', 'c3'].forEach(c => {
                        document.getElementById('foLabel_' + c).textContent = data.labels[c] || c;
                        document.getElementById('foIndLabel_' + c).textContent = data.labels[c] || c;
                    });
                    document.getElementById('foLabel_other').textContent = data.labels.other || 'OTHER';
                }
            } catch (e) { console.error('Error loading labels:', e); }
        }

        // Lock Modal
        function handleLockBtn() {
            if (isLocked) {
                isLocked = false;
                document.getElementById('lockIndicator').textContent = 'üîì';
                document.getElementById('setupBtn').disabled = false;
                document.getElementById('lockBtn').textContent = 'Lock';
                document.getElementById('lockBtn').classList.remove('locked');
                showToast('Unlocked');
            } else {
                document.getElementById('lockModal').classList.add('active');
            }
        }

        function closeLockModal() { document.getElementById('lockModal').classList.remove('active'); }

        function justLock() {
            closeLockModal();
            doLock();
        }

        function doLock() {
            isLocked = true;
            document.getElementById('lockIndicator').textContent = 'üîí';
            document.getElementById('setupBtn').disabled = true;
            document.getElementById('lockBtn').textContent = 'Unlock';
            document.getElementById('lockBtn').classList.add('locked');
            showToast('Locked');
        }

        function savePeriodAndLock() {
            closeLockModal();
            savePeriod();
            doLock();
        }

        async function saveGameAndLock() {
            closeLockModal();
            await saveGame();
            doLock();
        }

        // Faceoffs
        function foTap(center, type) {
            if (type === 'w') { 
                gameState.fo[center].w++; 
                document.getElementById('foBtnW_' + center).textContent = gameState.fo[center].w; 
            } else { 
                gameState.fo[center].l++; 
                document.getElementById('foBtnL_' + center).textContent = gameState.fo[center].l; 
            }
            updateCardStats(center);
            updatePeriodDisplay();
            updateCardColors();
        }

        function foDec(center, type) {
            if (type === 'w' && gameState.fo[center].w > 0) { 
                gameState.fo[center].w--; 
                document.getElementById('foBtnW_' + center).textContent = gameState.fo[center].w || 'W'; 
            } else if (type === 'l' && gameState.fo[center].l > 0) { 
                gameState.fo[center].l--; 
                document.getElementById('foBtnL_' + center).textContent = gameState.fo[center].l || 'L'; 
            }
            updateCardStats(center);
            updatePeriodDisplay();
            updateCardColors();
        }

        function updateCardStats(center) {
            const w = gameState.fo[center].w, l = gameState.fo[center].l;
            document.getElementById('foStats_' + center).textContent = w + '-' + l;
        }

        // Goalie
        function tapShot() { 
            gameState.periodShots++; 
            gameState.totalShots++; 
            document.getElementById('shotCount').textContent = gameState.totalShots; 
            updateGoalieStats(); 
            updatePeriodDisplay(); 
        }
        function tapGoal() { 
            gameState.periodGoals++; 
            gameState.totalGoals++; 
            document.getElementById('goalCount').textContent = gameState.totalGoals; 
            updateGoalieStats(); 
            updatePeriodDisplay(); 
        }
        function undoShot() { 
            if (gameState.periodShots > 0 && gameState.totalShots > 0) { 
                gameState.periodShots--; 
                gameState.totalShots--; 
                document.getElementById('shotCount').textContent = gameState.totalShots; 
                updateGoalieStats(); 
                updatePeriodDisplay(); 
            } 
        }
        function undoGoal() { 
            if (gameState.periodGoals > 0 && gameState.totalGoals > 0) { 
                gameState.periodGoals--; 
                gameState.totalGoals--; 
                document.getElementById('goalCount').textContent = gameState.totalGoals; 
                updateGoalieStats(); 
                updatePeriodDisplay(); 
            } 
        }

        function updateGoalieStats() {
            const totalShots = gameState.totalShots + gameState.totalGoals;
            const ga = gameState.totalGoals;
            const saves = gameState.totalShots;
            document.getElementById('statShots').textContent = totalShots || '-';
            document.getElementById('statGA').textContent = ga || '-';
            const svPctEl = document.getElementById('statSVPct');
            if (totalShots === 0) { svPctEl.textContent = '-'; }
            else { svPctEl.textContent = (saves / totalShots).toFixed(3); }
        }

        function updatePeriodDisplay() {
            let foW = 0, foL = 0;
            ['c1', 'c2', 'c3', 'other'].forEach(c => { foW += gameState.fo[c].w; foL += gameState.fo[c].l; });
            const foTotal = foW + foL;
            const foPct = foTotal > 0 ? Math.round((foW / foTotal) * 100) : 0;
            
            const periodShots = gameState.periodShots + gameState.periodGoals;
            const periodGA = gameState.periodGoals;
            const svPct = periodShots > 0 ? Math.round(((periodShots - periodGA) / periodShots) * 100) : 0;
            
            const el = document.getElementById('periodP' + currentPeriod + 'Data');
            if (el && (foTotal > 0 || periodShots > 0)) { 
                el.textContent = `${foW}/${foTotal} ${foPct}%, ${periodShots}/${periodGA} ${svPct}%`; 
                el.classList.remove('empty'); 
            }
            updateGameTotalsDisplay();
        }

        function updateGameTotalsDisplay() {
            let totalFoW = 0, totalFoL = 0;
            [1, 2, 3].forEach(p => { if (periodData[p]) { totalFoW += periodData[p].foW; totalFoL += periodData[p].foL; } });
            ['c1', 'c2', 'c3', 'other'].forEach(c => { totalFoW += gameState.fo[c].w; totalFoL += gameState.fo[c].l; });
            const foTotal = totalFoW + totalFoL;
            const foPct = foTotal > 0 ? Math.round((totalFoW / foTotal) * 100) : 0;
            
            const totalShots = gameState.totalShots + gameState.totalGoals;
            const totalGA = gameState.totalGoals;
            const svPct = totalShots > 0 ? Math.round(((totalShots - totalGA) / totalShots) * 100) : 0;
            
            const gameEl = document.getElementById('periodGameData');
            if (foTotal > 0 || totalShots > 0) { 
                gameEl.textContent = `${totalFoW}/${foTotal} ${foPct}%, ${totalShots}/${totalGA} ${svPct}%`; 
                gameEl.classList.remove('empty'); 
            }
            
            updateCumulativeFOStats();
        }
        
        function updateCumulativeFOStats() {
            ['c1', 'c2', 'c3', 'other'].forEach(c => {
                let w = 0, l = 0;
                [1, 2, 3].forEach(p => { 
                    if (periodData[p] && periodData[p].fo[c]) { 
                        w += periodData[p].fo[c].w; 
                        l += periodData[p].fo[c].l; 
                    } 
                });
                w += gameState.fo[c].w;
                l += gameState.fo[c].l;
                const total = w + l;
                const indEl = document.getElementById('foIndValue_' + c);
                if (total === 0) { indEl.textContent = '-'; }
                else { 
                    const pct = Math.round((w / total) * 100);
                    indEl.textContent = `${w}/${total} ${pct}%`; 
                }
            });
            
            let totalW = 0, totalL = 0;
            [1, 2, 3].forEach(p => { if (periodData[p]) { totalW += periodData[p].foW; totalL += periodData[p].foL; } });
            ['c1', 'c2', 'c3', 'other'].forEach(c => { totalW += gameState.fo[c].w; totalL += gameState.fo[c].l; });
            const total = totalW + totalL;
            document.getElementById('foTeamSub').textContent = totalW + 'W - ' + totalL + 'L';
            if (total === 0) { document.getElementById('foTeamPct').textContent = '-'; }
            else { document.getElementById('foTeamPct').textContent = Math.round((totalW / total) * 100) + '%'; }
        }

        function savePeriod() {
            let foW = 0, foL = 0;
            ['c1', 'c2', 'c3', 'other'].forEach(c => { foW += gameState.fo[c].w; foL += gameState.fo[c].l; });
            
            periodData[currentPeriod] = { 
                foW, 
                foL, 
                fo: JSON.parse(JSON.stringify(gameState.fo)), 
                shots: gameState.periodShots + gameState.periodGoals, 
                ga: gameState.periodGoals, 
                saves: gameState.periodShots 
            };
            
            document.getElementById('periodP' + currentPeriod).classList.add('saved');
            document.getElementById('periodP' + currentPeriod).classList.remove('active');
            const savedPeriod = currentPeriod;
            if (currentPeriod < 3) { 
                currentPeriod++; 
                document.getElementById('periodP' + currentPeriod).classList.add('active'); 
                resetPeriodCounters();
            }
            showToast('P' + savedPeriod + ' Saved!');
            updateGameTotalsDisplay();
        }

        function resetPeriodCounters() {
            ['c1', 'c2', 'c3', 'other'].forEach(c => {
                gameState.fo[c] = { w: 0, l: 0 };
                document.getElementById('foBtnW_' + c).textContent = 'W';
                document.getElementById('foBtnL_' + c).textContent = 'L';
                document.getElementById('foStats_' + c).textContent = '0-0';
            });
            
            gameState.periodShots = 0;
            gameState.periodGoals = 0;
            
            updateCumulativeFOStats();
            updateCardColors();
        }

        async function saveGame() {
            if (!SCRIPT_URL) { showToast('Setup required', true); return; }
            showToast('Saving...');
            
            let totalFo = { c1: { w: 0, l: 0 }, c2: { w: 0, l: 0 }, c3: { w: 0, l: 0 }, c4: { w: 0, l: 0 }, c5: { w: 0, l: 0 }, other: { w: 0, l: 0 } };
            [1, 2, 3].forEach(p => { 
                if (periodData[p]) { 
                    ['c1', 'c2', 'c3', 'other'].forEach(c => { 
                        totalFo[c].w += periodData[p].fo[c].w; 
                        totalFo[c].l += periodData[p].fo[c].l; 
                    }); 
                } 
            });
            ['c1', 'c2', 'c3', 'other'].forEach(c => { 
                totalFo[c].w += gameState.fo[c].w; 
                totalFo[c].l += gameState.fo[c].l; 
            });
            
            const totalShots = gameState.totalShots + gameState.totalGoals;
            const totalGA = gameState.totalGoals;
            
            const foParams = new URLSearchParams({ action: 'recordFOST', gameNum: gameState.gameNum });
            ['c1', 'c2', 'c3', 'c4', 'c5', 'other'].forEach(c => { 
                const w = totalFo[c].w, a = totalFo[c].w + totalFo[c].l; 
                foParams.append(c + 'w', w > 0 ? w.toString() : ''); 
                foParams.append(c + 'a', a > 0 ? a.toString() : ''); 
            });
            foParams.append('ppgf', ''); foParams.append('ppopp', ''); foParams.append('pkga', ''); foParams.append('pkopp', '');
            try { await fetch(SCRIPT_URL + '?' + foParams.toString(), { mode: 'no-cors' }); } catch (e) {}
            
            const goalieParams = new URLSearchParams({ 
                action: 'recordGoalie', 
                gameNum: gameState.gameNum, 
                goalie: gameState.goalie.value, 
                ga: totalGA.toString(), 
                shots: totalShots.toString(), 
                result: '' 
            });
            try { await fetch(SCRIPT_URL + '?' + goalieParams.toString(), { mode: 'no-cors' }); } catch (e) {}
            showToast('Game ' + gameState.gameNum + ' Saved!');
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function init() { 
            if (!SCRIPT_URL) { 
                document.getElementById('setupModal').classList.add('active'); 
            } else { 
                loadCenterLabels(); 
            }
            updateCardColors(); // Initialize colors on load
        }
        init();
    </script>
</body>
</html>
