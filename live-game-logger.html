<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Live Game Logger</title>
    <style>
        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; touch-action: manipulation; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #e8e8e8;
            color: #111;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            padding: 8px;
            gap: 6px;
        }

        /* HEADER */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            border-radius: 8px;
            padding: 4px 8px;
            flex-shrink: 0;
        }

        .header-left { display: flex; align-items: center; gap: 6px; }
        .lock-indicator { font-size: 18px; }

        .game-badge {
            background: #fbbf24;
            color: #000;
            padding: 3px 8px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }
        .game-badge-label { font-size: 7px; text-transform: uppercase; }
        .game-badge-num { font-size: 16px; line-height: 1; }

        .goalie-display {
            background: #000;
            border: 2px solid #fbbf24;
            border-radius: 6px;
            padding: 3px 8px;
            text-align: center;
        }
        .goalie-num { font-size: 16px; font-weight: bold; color: #fbbf24; line-height: 1; }
        .goalie-name { font-size: 8px; color: #aaa; }

        .header-center { display: flex; gap: 3px; }

        .period-summary {
            text-align: center;
            padding: 3px 5px;
            border-radius: 6px;
            background: #555;
            min-width: 90px;
        }
        .period-summary.active { background: #fbbf24; color: #000; }
        .period-summary.saved { background: #22c55e; color: #fff; }
        .period-label { font-size: 8px; text-transform: uppercase; color: #ccc; }
        .period-summary.active .period-label { color: #333; }
        .period-summary.saved .period-label { color: #fff; }
        .period-data { font-size: 9px; font-weight: bold; color: #fff; white-space: nowrap; }
        .period-summary.active .period-data { color: #000; }
        .period-data.empty { opacity: 0.5; }

        .header-right { display: flex; gap: 4px; }

        .header-btn {
            padding: 6px 10px;
            background: #6366f1;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            font-size: 10px;
            cursor: pointer;
        }
        .header-btn:disabled { opacity: 0.5; }
        .header-btn.locked { background: #dc2626; }

        /* FACEOFFS - 55% of space */
        .fo-section {
            flex: 55;
            background: #d0d0d0;
            border-radius: 10px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .fo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            flex: 1;
            min-height: 0;
        }

        .fo-card {
            border-radius: 12px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            border: 4px solid;
            min-height: 0;
            overflow: hidden;
        }
        
        .fo-card.c1 { background: #3b82f6; border-color: #1d4ed8; }
        .fo-card.c2 { background: #a855f7; border-color: #7c3aed; }
        .fo-card.c3 { background: #14b8a6; border-color: #0d9488; }
        .fo-card.other { background: #f97316; border-color: #ea580c; }

        .fo-card-label {
            font-size: 48px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
            line-height: 1;
            text-align: center;
            flex-shrink: 0;
        }

        .fo-tap-row { 
            display: flex; 
            gap: 8px; 
            flex: 1;
            margin-top: 4px;
            min-height: 0;
        }

        .fo-tap-btn {
            flex: 1;
            border: none;
            border-radius: 10px;
            font-size: 32px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px;
        }
        .fo-tap-btn:active { transform: scale(0.97); }
        .fo-tap-btn.win { background: #15803d; }
        .fo-tap-btn.loss { background: #b91c1c; }

        .fo-card-bottom {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            flex-shrink: 0;
        }

        .fo-card-stats { 
            background: rgba(0,0,0,0.3);
            padding: 2px 10px;
            border-radius: 4px;
            color: #fff;
            font-weight: bold;
            font-size: 14px;
        }

        .fo-dec-btn {
            width: 32px;
            height: 24px;
            border: none;
            border-radius: 4px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        /* TEAM TOTAL */
        .fo-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            border-radius: 8px;
            padding: 6px 12px;
            margin-top: 6px;
            flex-shrink: 0;
        }
        
        .fo-total-team { display: flex; align-items: center; gap: 10px; }
        .fo-total-label { font-size: 14px; color: #aaa; text-transform: uppercase; font-weight: bold; }
        .fo-total-pct { font-size: 28px; font-weight: bold; color: #fff; }
        .fo-total-sub { font-size: 14px; color: #ccc; font-weight: bold; }
        
        .fo-individual-stats { display: flex; gap: 5px; }
        .fo-ind-stat { text-align: center; padding: 3px 8px; border-radius: 5px; }
        .fo-ind-stat.c1 { background: #3b82f6; }
        .fo-ind-stat.c2 { background: #a855f7; }
        .fo-ind-stat.c3 { background: #14b8a6; }
        .fo-ind-stat.other { background: #f97316; }
        .fo-ind-label { font-size: 9px; font-weight: bold; color: #fff; }
        .fo-ind-value { font-size: 12px; font-weight: bold; color: #fff; }

        /* GOALIE - 45% of space */
        .goalie-section {
            flex: 45;
            background: #333;
            border-radius: 10px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .goalie-tap-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            flex: 1;
            min-height: 0;
        }
        
        .goalie-tap-wrapper { 
            display: flex; 
            flex-direction: column; 
            min-height: 0;
        }

        .goalie-tap-btn {
            flex: 1;
            min-height: 100px;
            border-radius: 12px;
            border: 4px solid;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .goalie-tap-btn:active { transform: scale(0.97); }
        .goalie-tap-btn.shot { background: #15803d; border-color: #22c55e; }
        .goalie-tap-btn.goal { background: #b91c1c; border-color: #ef4444; }
        .goalie-tap-label { font-size: 18px; font-weight: bold; color: white; text-transform: uppercase; }
        .goalie-tap-count { font-size: 56px; font-weight: bold; color: white; line-height: 1; }

        .goalie-tap-dec {
            width: 60%;
            height: 28px;
            margin: 4px auto 0;
            background: #555;
            border: none;
            border-radius: 5px;
            color: #fff;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
        }

        .goalie-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            background: #222;
            border-radius: 8px;
            padding: 8px;
            margin-top: 6px;
            flex-shrink: 0;
        }
        .goalie-stat-item { text-align: center; }
        .goalie-stat-value { font-size: 28px; font-weight: bold; color: #fff; }
        .goalie-stat-value.shots { color: #22c55e; }
        .goalie-stat-value.ga { color: #ef4444; }
        .goalie-stat-value.svpct { color: #fbbf24; }
        .goalie-stat-label { font-size: 10px; color: #aaa; text-transform: uppercase; }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #15803d;
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 18px;
            transition: transform 0.3s ease;
            z-index: 200;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.error { background: #b91c1c; }

        /* MODALS */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: #2a2a2a;
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
        }

        .modal-title { font-size: 20px; font-weight: bold; color: #fbbf24; text-align: center; margin-bottom: 20px; }
        .modal-section { margin-bottom: 20px; }
        .modal-section label { display: block; font-size: 12px; color: #aaa; text-transform: uppercase; margin-bottom: 8px; }

        .modal-input {
            width: 100%;
            padding: 14px;
            background: #444;
            border: 2px solid #555;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
        }
        .modal-input:focus { outline: none; border-color: #6366f1; }

        .goalie-select-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

        .goalie-select-btn {
            padding: 15px 10px;
            background: #444;
            border: 2px solid #555;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
        }
        .goalie-select-btn.selected { background: #6366f1; border-color: #6366f1; }
        .goalie-select-btn .num { font-size: 24px; font-weight: bold; color: #fbbf24; }
        .goalie-select-btn.selected .num { color: white; }
        .goalie-select-btn .name { font-size: 11px; color: #aaa; }
        .goalie-select-btn.selected .name { color: #ddd; }

        .modal-buttons { display: flex; gap: 10px; flex-wrap: wrap; }

        .modal-btn {
            flex: 1;
            min-width: 45%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-btn.cancel { background: #555; color: #fff; }
        .modal-btn.confirm { background: #15803d; color: white; }
        .modal-btn.period { background: #6366f1; color: white; }
        .modal-btn.game { background: #15803d; color: white; }
        .modal-btn.lock-only { background: #dc2626; color: white; }

        .url-note { font-size: 11px; color: #888; margin-top: 8px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-bar">
            <div class="header-left">
                <span class="lock-indicator" id="lockIndicator">üîì</span>
                <div class="game-badge">
                    <div class="game-badge-label">Game</div>
                    <div class="game-badge-num" id="gameNum">1</div>
                </div>
                <div class="goalie-display">
                    <div class="goalie-num" id="goalieNum">#31</div>
                    <div class="goalie-name" id="goalieName">Tomasula</div>
                </div>
            </div>
            <div class="header-center">
                <div class="period-summary active" id="periodP1">
                    <div class="period-label">P1</div>
                    <div class="period-data empty" id="periodP1Data">--</div>
                </div>
                <div class="period-summary" id="periodP2">
                    <div class="period-label">P2</div>
                    <div class="period-data empty" id="periodP2Data">--</div>
                </div>
                <div class="period-summary" id="periodP3">
                    <div class="period-label">P3</div>
                    <div class="period-data empty" id="periodP3Data">--</div>
                </div>
                <div class="period-summary" id="periodGame">
                    <div class="period-label">Game</div>
                    <div class="period-data empty" id="periodGameData">--</div>
                </div>
            </div>
            <div class="header-right">
                <button class="header-btn" id="setupBtn" onclick="openSetup()">Setup</button>
                <button class="header-btn" id="lockBtn" onclick="handleLockBtn()">Lock</button>
            </div>
        </div>

        <div class="fo-section">
            <div class="fo-grid">
                <div class="fo-card c1">
                    <div class="fo-card-label" id="foLabel_c1">c1</div>
                    <div class="fo-tap-row">
                        <button class="fo-tap-btn win" id="foBtnW_c1" onclick="foTap('c1', 'w')">W</button>
                        <button class="fo-tap-btn loss" id="foBtnL_c1" onclick="foTap('c1', 'l')">L</button>
                    </div>
                    <div class="fo-card-bottom">
                        <button class="fo-dec-btn" onclick="foDec('c1', 'w')">‚àí</button>
                        <span class="fo-card-stats" id="foStats_c1">0-0</span>
                        <button class="fo-dec-btn" onclick="foDec('c1', 'l')">‚àí</button>
                    </div>
                </div>
                <div class="fo-card c2">
                    <div class="fo-card-label" id="foLabel_c2">c2</div>
                    <div class="fo-tap-row">
                        <button class="fo-tap-btn win" id="foBtnW_c2" onclick="foTap('c2', 'w')">W</button>
                        <button class="fo-tap-btn loss" id="foBtnL_c2" onclick="foTap('c2', 'l')">L</button>
                    </div>
                    <div class="fo-card-bottom">
                        <button class="fo-dec-btn" onclick="foDec('c2', 'w')">‚àí</button>
                        <span class="fo-card-stats" id="foStats_c2">0-0</span>
                        <button class="fo-dec-btn" onclick="foDec('c2', 'l')">‚àí</button>
                    </div>
                </div>
                <div class="fo-card c3">
                    <div class="fo-card-label" id="foLabel_c3">c3</div>
                    <div class="fo-tap-row">
                        <button class="fo-tap-btn win" id="foBtnW_c3" onclick="foTap('c3', 'w')">W</button>
                        <button class="fo-tap-btn loss" id="foBtnL_c3" onclick="foTap('c3', 'l')">L</button>
                    </div>
                    <div class="fo-card-bottom">
                        <button class="fo-dec-btn" onclick="foDec('c3', 'w')">‚àí</button>
                        <span class="fo-card-stats" id="foStats_c3">0-0</span>
                        <button class="fo-dec-btn" onclick="foDec('c3', 'l')">‚àí</button>
                    </div>
                </div>
                <div class="fo-card other">
                    <div class="fo-card-label" id="foLabel_other">OTHER</div>
                    <div class="fo-tap-row">
                        <button class="fo-tap-btn win" id="foBtnW_other" onclick="foTap('other', 'w')">W</button>
                        <button class="fo-tap-btn loss" id="foBtnL_other" onclick="foTap('other', 'l')">L</button>
                    </div>
                    <div class="fo-card-bottom">
                        <button class="fo-dec-btn" onclick="foDec('other', 'w')">‚àí</button>
                        <span class="fo-card-stats" id="foStats_other">0-0</span>
                        <button class="fo-dec-btn" onclick="foDec('other', 'l')">‚àí</button>
                    </div>
                </div>
            </div>
            <div class="fo-total">
                <div class="fo-total-team">
                    <span class="fo-total-label">Team</span>
                    <span class="fo-total-pct" id="foTeamPct">-</span>
                    <span class="fo-total-sub" id="foTeamSub">0W - 0L</span>
                </div>
                <div class="fo-individual-stats">
                    <div class="fo-ind-stat c1">
                        <div class="fo-ind-label" id="foIndLabel_c1">c1</div>
                        <div class="fo-ind-value" id="foIndValue_c1">-</div>
                    </div>
                    <div class="fo-ind-stat c2">
                        <div class="fo-ind-label" id="foIndLabel_c2">c2</div>
                        <div class="fo-ind-value" id="foIndValue_c2">-</div>
                    </div>
                    <div class="fo-ind-stat c3">
                        <div class="fo-ind-label" id="foIndLabel_c3">c3</div>
                        <div class="fo-ind-value" id="foIndValue_c3">-</div>
                    </div>
                    <div class="fo-ind-stat other">
                        <div class="fo-ind-label">OTH</div>
                        <div class="fo-ind-value" id="foIndValue_other">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="goalie-section">
            <div class="goalie-tap-grid">
                <div class="goalie-tap-wrapper">
                    <div class="goalie-tap-btn shot" onclick="tapShot()">
                        <div class="goalie-tap-label">Shot</div>
                        <div class="goalie-tap-count" id="shotCount">0</div>
                    </div>
                    <button class="goalie-tap-dec" onclick="undoShot()">‚àí Undo</button>
                </div>
                <div class="goalie-tap-wrapper">
                    <div class="goalie-tap-btn goal" onclick="tapGoal()">
                        <div class="goalie-tap-label">Goal</div>
                        <div class="goalie-tap-count" id="goalCount">0</div>
                    </div>
                    <button class="goalie-tap-dec" onclick="undoGoal()">‚àí Undo</button>
                </div>
            </div>
            <div class="goalie-stats">
                <div class="goalie-stat-item">
                    <div class="goalie-stat-value shots" id="statShots">-</div>
                    <div class="goalie-stat-label">Shots</div>
                </div>
                <div class="goalie-stat-item">
                    <div class="goalie-stat-value ga" id="statGA">-</div>
                    <div class="goalie-stat-label">GA</div>
                </div>
                <div class="goalie-stat-item">
                    <div class="goalie-stat-value svpct" id="statSVPct">-</div>
                    <div class="goalie-stat-label">SV%</div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Setup Modal -->
    <div class="modal-overlay" id="setupModal">
        <div class="modal">
            <div class="modal-title">‚öôÔ∏è Game Setup</div>
            <div class="modal-section">
                <label>Apps Script URL</label>
                <input type="text" class="modal-input" id="scriptUrl" placeholder="Paste Google Apps Script URL">
                <div class="url-note">Same URL used in main stat entry app</div>
            </div>
            <div class="modal-section">
                <label>Game Number</label>
                <input type="number" class="modal-input" id="inputGameNum" min="1" max="50" value="1">
            </div>
            <div class="modal-section">
                <label>Goalie</label>
                <div class="goalie-select-grid">
                    <div class="goalie-select-btn selected" id="setupGoalie31" onclick="selectSetupGoalie(31, 'Tomasula')">
                        <div class="num">#31</div>
                        <div class="name">Tomasula</div>
                    </div>
                    <div class="goalie-select-btn" id="setupGoalie41" onclick="selectSetupGoalie(41, 'Goodwin')">
                        <div class="num">#41</div>
                        <div class="name">Goodwin</div>
                    </div>
                    <div class="goalie-select-btn" id="setupGoalie67" onclick="selectSetupGoalie(67, 'Nease')">
                        <div class="num">#67</div>
                        <div class="name">Nease</div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeSetup()">Cancel</button>
                <button class="modal-btn confirm" onclick="confirmSetup()">Start Game</button>
            </div>
        </div>
    </div>

    <!-- Lock/Save Modal - shows when you tap Lock -->
    <div class="modal-overlay" id="lockModal">
        <div class="modal">
            <div class="modal-title">üîí Save & Lock</div>
            <div class="modal-buttons">
                <button class="modal-btn period" onclick="savePeriodAndLock()">Save Period</button>
                <button class="modal-btn game" onclick="saveGameAndLock()">Save Game</button>
                <button class="modal-btn lock-only" onclick="justLock()">Just Lock</button>
                <button class="modal-btn cancel" onclick="closeLockModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let SCRIPT_URL = localStorage.getItem('hockeyScriptUrl') || '';
        let isLocked = false;
        let currentPeriod = 1;

        const gameState = {
            gameNum: 1,
            goalie: { num: 31, name: 'Tomasula', value: '#31 Tomasula' },
            fo: { c1: { w: 0, l: 0 }, c2: { w: 0, l: 0 }, c3: { w: 0, l: 0 }, other: { w: 0, l: 0 } },
            labels: { c1: 'c1', c2: 'c2', c3: 'c3', other: 'OTHER' },
            periodShots: 0,  // Current period shots (saves)
            periodGoals: 0,  // Current period goals against
            totalShots: 0,   // Cumulative game shots (saves)
            totalGoals: 0    // Cumulative game goals against
        };

        const periodData = { 1: null, 2: null, 3: null };
        const setupState = { goalie: { num: 31, name: 'Tomasula' } };

        // Setup Modal
        function openSetup() {
            if (isLocked) return;
            document.getElementById('setupModal').classList.add('active');
            document.getElementById('scriptUrl').value = SCRIPT_URL;
            document.getElementById('inputGameNum').value = gameState.gameNum;
        }

        function closeSetup() { document.getElementById('setupModal').classList.remove('active'); }

        function selectSetupGoalie(num, name) {
            setupState.goalie = { num, name };
            document.querySelectorAll('.goalie-select-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('setupGoalie' + num).classList.add('selected');
        }

        async function confirmSetup() {
            const url = document.getElementById('scriptUrl').value.trim();
            const gameNum = parseInt(document.getElementById('inputGameNum').value) || 1;
            if (!url) { showToast('Enter Apps Script URL', true); return; }
            SCRIPT_URL = url;
            localStorage.setItem('hockeyScriptUrl', url);
            gameState.gameNum = gameNum;
            gameState.goalie = { num: setupState.goalie.num, name: setupState.goalie.name, value: '#' + setupState.goalie.num + ' ' + setupState.goalie.name };
            document.getElementById('gameNum').textContent = gameNum;
            document.getElementById('goalieNum').textContent = '#' + setupState.goalie.num;
            document.getElementById('goalieName').textContent = setupState.goalie.name;
            await loadCenterLabels();
            closeSetup();
            showToast('Game ' + gameNum + ' ready!');
        }

        async function loadCenterLabels() {
            if (!SCRIPT_URL) return;
            try {
                const response = await fetch(SCRIPT_URL + '?action=getFOSTState&gameNum=' + gameState.gameNum + '&t=' + Date.now());
                const data = await response.json();
                if (data.labels) {
                    gameState.labels = data.labels;
                    ['c1', 'c2', 'c3'].forEach(c => {
                        document.getElementById('foLabel_' + c).textContent = data.labels[c] || c;
                        document.getElementById('foIndLabel_' + c).textContent = data.labels[c] || c;
                    });
                    document.getElementById('foLabel_other').textContent = data.labels.other || 'OTHER';
                }
            } catch (e) { console.error('Error loading labels:', e); }
        }

        // Lock Modal - tap Lock button shows save options
        function handleLockBtn() {
            if (isLocked) {
                // Unlock immediately
                isLocked = false;
                document.getElementById('lockIndicator').textContent = 'üîì';
                document.getElementById('setupBtn').disabled = false;
                document.getElementById('lockBtn').textContent = 'Lock';
                document.getElementById('lockBtn').classList.remove('locked');
                showToast('Unlocked');
            } else {
                // Show save options modal
                document.getElementById('lockModal').classList.add('active');
            }
        }

        function closeLockModal() { document.getElementById('lockModal').classList.remove('active'); }

        function justLock() {
            closeLockModal();
            doLock();
        }

        function doLock() {
            isLocked = true;
            document.getElementById('lockIndicator').textContent = 'üîí';
            document.getElementById('setupBtn').disabled = true;
            document.getElementById('lockBtn').textContent = 'Unlock';
            document.getElementById('lockBtn').classList.add('locked');
            showToast('Locked');
        }

        function savePeriodAndLock() {
            closeLockModal();
            savePeriod();
            doLock();
        }

        async function saveGameAndLock() {
            closeLockModal();
            await saveGame();
            doLock();
        }

        // Faceoffs - per period counters, cumulative stats in bottom bar
        function foTap(center, type) {
            if (type === 'w') { 
                gameState.fo[center].w++; 
                document.getElementById('foBtnW_' + center).textContent = gameState.fo[center].w; 
            } else { 
                gameState.fo[center].l++; 
                document.getElementById('foBtnL_' + center).textContent = gameState.fo[center].l; 
            }
            updateCardStats(center);
            updatePeriodDisplay();
        }

        function foDec(center, type) {
            if (type === 'w' && gameState.fo[center].w > 0) { 
                gameState.fo[center].w--; 
                document.getElementById('foBtnW_' + center).textContent = gameState.fo[center].w || 'W'; 
            } else if (type === 'l' && gameState.fo[center].l > 0) { 
                gameState.fo[center].l--; 
                document.getElementById('foBtnL_' + center).textContent = gameState.fo[center].l || 'L'; 
            }
            updateCardStats(center);
            updatePeriodDisplay();
        }

        function updateCardStats(center) {
            // Show current period stats on the card
            const w = gameState.fo[center].w, l = gameState.fo[center].l;
            document.getElementById('foStats_' + center).textContent = w + '-' + l;
        }

        // Goalie - tracks both period and cumulative
        function tapShot() { 
            gameState.periodShots++; 
            gameState.totalShots++; 
            document.getElementById('shotCount').textContent = gameState.totalShots; 
            updateGoalieStats(); 
            updatePeriodDisplay(); 
        }
        function tapGoal() { 
            gameState.periodGoals++; 
            gameState.totalGoals++; 
            document.getElementById('goalCount').textContent = gameState.totalGoals; 
            updateGoalieStats(); 
            updatePeriodDisplay(); 
        }
        function undoShot() { 
            if (gameState.periodShots > 0 && gameState.totalShots > 0) { 
                gameState.periodShots--; 
                gameState.totalShots--; 
                document.getElementById('shotCount').textContent = gameState.totalShots; 
                updateGoalieStats(); 
                updatePeriodDisplay(); 
            } 
        }
        function undoGoal() { 
            if (gameState.periodGoals > 0 && gameState.totalGoals > 0) { 
                gameState.periodGoals--; 
                gameState.totalGoals--; 
                document.getElementById('goalCount').textContent = gameState.totalGoals; 
                updateGoalieStats(); 
                updatePeriodDisplay(); 
            } 
        }

        function updateGoalieStats() {
            // Always show CUMULATIVE totals in goalie section
            const totalShots = gameState.totalShots + gameState.totalGoals;
            const ga = gameState.totalGoals;
            const saves = gameState.totalShots;
            document.getElementById('statShots').textContent = totalShots || '-';
            document.getElementById('statGA').textContent = ga || '-';
            const svPctEl = document.getElementById('statSVPct');
            if (totalShots === 0) { svPctEl.textContent = '-'; }
            else { svPctEl.textContent = (saves / totalShots).toFixed(3); }
        }

        // Period tracking
        function updatePeriodDisplay() {
            // Current period faceoffs
            let foW = 0, foL = 0;
            ['c1', 'c2', 'c3', 'other'].forEach(c => { foW += gameState.fo[c].w; foL += gameState.fo[c].l; });
            const foTotal = foW + foL;
            const foPct = foTotal > 0 ? Math.round((foW / foTotal) * 100) : 0;
            
            // Current period goalie (just current period, not cumulative)
            const periodShots = gameState.periodShots + gameState.periodGoals;
            const periodGA = gameState.periodGoals;
            const svPct = periodShots > 0 ? Math.round(((periodShots - periodGA) / periodShots) * 100) : 0;
            
            const el = document.getElementById('periodP' + currentPeriod + 'Data');
            if (el && (foTotal > 0 || periodShots > 0)) { 
                el.textContent = `${foW}/${foTotal} ${foPct}%, ${periodShots}/${periodGA} ${svPct}%`; 
                el.classList.remove('empty'); 
            }
            updateGameTotalsDisplay();
        }

        function updateGameTotalsDisplay() {
            // Game total faceoffs (all periods + current)
            let totalFoW = 0, totalFoL = 0;
            [1, 2, 3].forEach(p => { if (periodData[p]) { totalFoW += periodData[p].foW; totalFoL += periodData[p].foL; } });
            ['c1', 'c2', 'c3', 'other'].forEach(c => { totalFoW += gameState.fo[c].w; totalFoL += gameState.fo[c].l; });
            const foTotal = totalFoW + totalFoL;
            const foPct = foTotal > 0 ? Math.round((totalFoW / foTotal) * 100) : 0;
            
            // Game total goalie (cumulative)
            const totalShots = gameState.totalShots + gameState.totalGoals;
            const totalGA = gameState.totalGoals;
            const svPct = totalShots > 0 ? Math.round(((totalShots - totalGA) / totalShots) * 100) : 0;
            
            const gameEl = document.getElementById('periodGameData');
            if (foTotal > 0 || totalShots > 0) { 
                gameEl.textContent = `${totalFoW}/${foTotal} ${foPct}%, ${totalShots}/${totalGA} ${svPct}%`; 
                gameEl.classList.remove('empty'); 
            }
            
            // Update cumulative individual FO stats in bottom bar
            updateCumulativeFOStats();
        }
        
        function updateCumulativeFOStats() {
            ['c1', 'c2', 'c3', 'other'].forEach(c => {
                // Sum all saved periods + current
                let w = 0, l = 0;
                [1, 2, 3].forEach(p => { 
                    if (periodData[p] && periodData[p].fo[c]) { 
                        w += periodData[p].fo[c].w; 
                        l += periodData[p].fo[c].l; 
                    } 
                });
                w += gameState.fo[c].w;
                l += gameState.fo[c].l;
                const total = w + l;
                const indEl = document.getElementById('foIndValue_' + c);
                if (total === 0) { indEl.textContent = '-'; }
                else { indEl.textContent = Math.round((w / total) * 100) + '%'; }
            });
            
            // Update team total (cumulative)
            let totalW = 0, totalL = 0;
            [1, 2, 3].forEach(p => { if (periodData[p]) { totalW += periodData[p].foW; totalL += periodData[p].foL; } });
            ['c1', 'c2', 'c3', 'other'].forEach(c => { totalW += gameState.fo[c].w; totalL += gameState.fo[c].l; });
            const total = totalW + totalL;
            document.getElementById('foTeamSub').textContent = totalW + 'W - ' + totalL + 'L';
            if (total === 0) { document.getElementById('foTeamPct').textContent = '-'; }
            else { document.getElementById('foTeamPct').textContent = Math.round((totalW / total) * 100) + '%'; }
        }

        function savePeriod() {
            let foW = 0, foL = 0;
            ['c1', 'c2', 'c3', 'other'].forEach(c => { foW += gameState.fo[c].w; foL += gameState.fo[c].l; });
            
            // Save period data including this period's goalie stats
            periodData[currentPeriod] = { 
                foW, 
                foL, 
                fo: JSON.parse(JSON.stringify(gameState.fo)), 
                shots: gameState.periodShots + gameState.periodGoals, 
                ga: gameState.periodGoals, 
                saves: gameState.periodShots 
            };
            
            document.getElementById('periodP' + currentPeriod).classList.add('saved');
            document.getElementById('periodP' + currentPeriod).classList.remove('active');
            const savedPeriod = currentPeriod;
            if (currentPeriod < 3) { 
                currentPeriod++; 
                document.getElementById('periodP' + currentPeriod).classList.add('active'); 
                resetPeriodCounters(); // Only reset period counters, not cumulative
            }
            showToast('P' + savedPeriod + ' Saved!');
            updateGameTotalsDisplay();
        }

        function resetPeriodCounters() {
            // Reset faceoff counters for new period
            ['c1', 'c2', 'c3', 'other'].forEach(c => {
                gameState.fo[c] = { w: 0, l: 0 };
                document.getElementById('foBtnW_' + c).textContent = 'W';
                document.getElementById('foBtnL_' + c).textContent = 'L';
                document.getElementById('foStats_' + c).textContent = '0-0';
            });
            
            // Reset period goalie counters (but NOT cumulative totals)
            gameState.periodShots = 0;
            gameState.periodGoals = 0;
            
            // DON'T reset totalShots/totalGoals - goalie display stays cumulative
            // DON'T reset shotCount/goalCount display - shows cumulative
            
            updateCumulativeFOStats();
        }

        async function saveGame() {
            if (!SCRIPT_URL) { showToast('Setup required', true); return; }
            showToast('Saving...');
            
            // Cumulative faceoffs from all periods + current
            let totalFo = { c1: { w: 0, l: 0 }, c2: { w: 0, l: 0 }, c3: { w: 0, l: 0 }, c4: { w: 0, l: 0 }, c5: { w: 0, l: 0 }, other: { w: 0, l: 0 } };
            [1, 2, 3].forEach(p => { 
                if (periodData[p]) { 
                    ['c1', 'c2', 'c3', 'other'].forEach(c => { 
                        totalFo[c].w += periodData[p].fo[c].w; 
                        totalFo[c].l += periodData[p].fo[c].l; 
                    }); 
                } 
            });
            ['c1', 'c2', 'c3', 'other'].forEach(c => { 
                totalFo[c].w += gameState.fo[c].w; 
                totalFo[c].l += gameState.fo[c].l; 
            });
            
            // Use cumulative goalie totals
            const totalShots = gameState.totalShots + gameState.totalGoals;
            const totalGA = gameState.totalGoals;
            
            const foParams = new URLSearchParams({ action: 'recordFOST', gameNum: gameState.gameNum });
            ['c1', 'c2', 'c3', 'c4', 'c5', 'other'].forEach(c => { 
                const w = totalFo[c].w, a = totalFo[c].w + totalFo[c].l; 
                foParams.append(c + 'w', w > 0 ? w.toString() : ''); 
                foParams.append(c + 'a', a > 0 ? a.toString() : ''); 
            });
            foParams.append('ppgf', ''); foParams.append('ppopp', ''); foParams.append('pkga', ''); foParams.append('pkopp', '');
            try { await fetch(SCRIPT_URL + '?' + foParams.toString(), { mode: 'no-cors' }); } catch (e) {}
            
            const goalieParams = new URLSearchParams({ 
                action: 'recordGoalie', 
                gameNum: gameState.gameNum, 
                goalie: gameState.goalie.value, 
                ga: totalGA.toString(), 
                shots: totalShots.toString(), 
                result: '' 
            });
            try { await fetch(SCRIPT_URL + '?' + goalieParams.toString(), { mode: 'no-cors' }); } catch (e) {}
            showToast('Game ' + gameState.gameNum + ' Saved!');
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function init() { if (!SCRIPT_URL) { document.getElementById('setupModal').classList.add('active'); } else { loadCenterLabels(); } }
        init();
    </script>
</body>
</html>
